{
  "hash": "232655def93ac2338452746c8c77c596",
  "result": {
    "engine": "knitr",
    "markdown": "---\norder: 5\ntitle: \"Working with spatial and geometric operations in `{sf}`\"\nsubtitle: \"Session {{< meta order >}}\"\ndate: 2023-09-27\nimage: \"images/st_intersects_postgis-intro.png\"\nformat:\n  revealjs:\n    output-location: column-fragment\n---\n\n## Getting started\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(tigris)\noptions(tigris_use_cache = TRUE)\n```\n:::\n\n\n------------------------------------------------------------------------\n\n\n::: {.cell}\n\n```{.r .cell-code}\noptions(\"tigris_use_cache\" = TRUE)\nus_states <- states()\nus_highways <- primary_roads()\nmaryland <- filter(us_states, NAME == \"Maryland\")\nlower48 <- filter(\n  us_states,\n  !(NAME %in%\n    c(\n      \"United States Virgin Islands\",\n      \"Commonwealth of the Northern Mariana Islands\",\n      \"Guam\",\n      \"Alaska\",\n      \"American Samoa\",\n      \"Puerto Rico\",\n      \"Hawaii\"\n    ))\n)\n```\n:::\n\n\n## Converting objects between types\n\n------------------------------------------------------------------------\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsfg <- st_point(c(-76.712838, 39.253383))\n\nsfg\n```\n:::\n\n\n------------------------------------------------------------------------\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_as_sfc(list(sfg))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGeometry set for 1 feature \nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -76.71284 ymin: 39.25338 xmax: -76.71284 ymax: 39.25338\nCRS:           NA\n```\n\n\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsfc <- st_as_sfc(list(sfg), crs = 4326)\n\nsfc\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGeometry set for 1 feature \nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -76.71284 ymin: 39.25338 xmax: -76.71284 ymax: 39.25338\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_as_sf(sfc)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 1 feature and 0 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -76.71284 ymin: 39.25338 xmax: -76.71284 ymax: 39.25338\nGeodetic CRS:  WGS 84\n                           x\n1 POINT (-76.71284 39.25338)\n```\n\n\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsf_df <- data.frame(\n  name = \"Example data frame\",\n  lon = -76.712838,\n  lat = 39.253383\n)\n\nsf <- st_as_sf(\n  sf_df,\n  coords = c(\"lon\", \"lat\"),\n  crs = 4326\n)\n\nsf\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 1 feature and 1 field\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -76.71284 ymin: 39.25338 xmax: -76.71284 ymax: 39.25338\nGeodetic CRS:  WGS 84\n                name                   geometry\n1 Example data frame POINT (-76.71284 39.25338)\n```\n\n\n:::\n:::\n\n\n## Types of spatial operations\n\n-   Spatial filtering and topological relations\n-   Spatial joins and non-overlapping joins\n-   Spatial aggregation\n\n### Spatial filtering and topological relations\n\n`st_filter()` defaults to intersecting geometries:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_filter(\n  us_states,\n  maryland\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 15 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -83.67539 ymin: 36.54085 xmax: -74.68956 ymax: 42.51607\nGeodetic CRS:  NAD83\n  REGION DIVISION STATEFP  STATENS GEOID     GEOIDFQ STUSPS\n1      3        5      54 01779805    54 0400000US54     WV\n2      3        5      24 01714934    24 0400000US24     MD\n3      3        5      10 01779781    10 0400000US10     DE\n4      1        2      42 01779798    42 0400000US42     PA\n5      3        5      51 01779803    51 0400000US51     VA\n6      3        5      11 01702382    11 0400000US11     DC\n                  NAME LSAD MTFCC FUNCSTAT        ALAND     AWATER    INTPTLAT\n1        West Virginia   00 G4000        A  62266513826  488918898 +38.6472854\n2             Maryland   00 G4000        A  25151223822 6979843236 +38.9466584\n3             Delaware   00 G4000        A   5046692239 1399219008 +38.9985661\n4         Pennsylvania   00 G4000        A 115881476238 3397613881 +40.9046042\n5             Virginia   00 G4000        A 102256342555 8529908321 +37.5222512\n6 District of Columbia   00 G4000        A    158316181   18709785 +38.9042474\n      INTPTLON                       geometry\n1 -080.6183274 MULTIPOLYGON (((-77.75438 3...\n2 -076.6744939 MULTIPOLYGON (((-75.756 39....\n3 -075.4416440 MULTIPOLYGON (((-75.50949 3...\n4 -077.8275233 MULTIPOLYGON (((-75.5931 39...\n5 -078.6681938 MULTIPOLYGON (((-76.9159 36...\n6 -077.0165167 MULTIPOLYGON (((-77.11975 3...\n```\n\n\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n`st_filter()` can also support alternate topological relations:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_filter(\n  us_states,\n  maryland,\n  .predicate = st_disjoint\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 50 features and 15 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -179.2311 ymin: -14.60181 xmax: 179.8597 ymax: 71.43979\nGeodetic CRS:  NAD83\nFirst 10 features:\n   REGION DIVISION STATEFP  STATENS GEOID     GEOIDFQ STUSPS           NAME\n1       3        5      12 00294478    12 0400000US12     FL        Florida\n2       2        3      17 01779784    17 0400000US17     IL       Illinois\n3       2        4      27 00662849    27 0400000US27     MN      Minnesota\n4       1        1      44 01219835    44 0400000US44     RI   Rhode Island\n5       4        8      16 01779783    16 0400000US16     ID          Idaho\n6       1        1      33 01779794    33 0400000US33     NH  New Hampshire\n7       3        5      37 01027616    37 0400000US37     NC North Carolina\n8       1        1      50 01779802    50 0400000US50     VT        Vermont\n9       1        1      09 01779780    09 0400000US09     CT    Connecticut\n10      4        8      35 00897535    35 0400000US35     NM     New Mexico\n   LSAD MTFCC FUNCSTAT        ALAND      AWATER    INTPTLAT     INTPTLON\n1    00 G4000        A 138965379385 45968913048 +28.3989775 -082.5143005\n2    00 G4000        A 143778206717  6216848695 +40.1028754 -089.1526108\n3    00 G4000        A 206244791203 18937236061 +46.3159573 -094.1996043\n4    00 G4000        A   2677768885  1323681453 +41.5964850 -071.5264901\n5    00 G4000        A 214050504522  2390996667 +44.3484222 -114.5588538\n6    00 G4000        A  23190211616  1025871482 +43.6727945 -071.5841886\n7    00 G4000        A 125935965771 13453455061 +35.5397100 -079.1308636\n8    00 G4000        A  23872594714  1030642813 +44.0589536 -072.6710173\n9    00 G4000        A  12541999507  1816115183 +41.5798637 -072.7466572\n10   00 G4000        A 314198519809   726531289 +34.4346843 -106.1316181\n                         geometry\n1  MULTIPOLYGON (((-83.10874 2...\n2  MULTIPOLYGON (((-87.89243 3...\n3  MULTIPOLYGON (((-95.31991 4...\n4  MULTIPOLYGON (((-71.67881 4...\n5  MULTIPOLYGON (((-116.3584 4...\n6  MULTIPOLYGON (((-70.83887 4...\n7  MULTIPOLYGON (((-77.89977 3...\n8  MULTIPOLYGON (((-72.04187 4...\n9  MULTIPOLYGON (((-72.5279 41...\n10 MULTIPOLYGON (((-103.0647 3...\n```\n\n\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n![](https://r.geocompx.org/figures/relations-1.png)\n\n### Spatial joins\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_join(maryland, us_highways)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 466 features and 19 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -79.48765 ymin: 37.88661 xmax: -74.98628 ymax: 39.72304\nGeodetic CRS:  NAD83\nFirst 10 features:\n    REGION DIVISION STATEFP  STATENS GEOID     GEOIDFQ STUSPS     NAME LSAD\n1        3        5      24 01714934    24 0400000US24     MD Maryland   00\n1.1      3        5      24 01714934    24 0400000US24     MD Maryland   00\n1.2      3        5      24 01714934    24 0400000US24     MD Maryland   00\n1.3      3        5      24 01714934    24 0400000US24     MD Maryland   00\n1.4      3        5      24 01714934    24 0400000US24     MD Maryland   00\n1.5      3        5      24 01714934    24 0400000US24     MD Maryland   00\n1.6      3        5      24 01714934    24 0400000US24     MD Maryland   00\n1.7      3        5      24 01714934    24 0400000US24     MD Maryland   00\n1.8      3        5      24 01714934    24 0400000US24     MD Maryland   00\n1.9      3        5      24 01714934    24 0400000US24     MD Maryland   00\n    MTFCC.x FUNCSTAT       ALAND     AWATER    INTPTLAT     INTPTLON\n1     G4000        A 25151223822 6979843236 +38.9466584 -076.6744939\n1.1   G4000        A 25151223822 6979843236 +38.9466584 -076.6744939\n1.2   G4000        A 25151223822 6979843236 +38.9466584 -076.6744939\n1.3   G4000        A 25151223822 6979843236 +38.9466584 -076.6744939\n1.4   G4000        A 25151223822 6979843236 +38.9466584 -076.6744939\n1.5   G4000        A 25151223822 6979843236 +38.9466584 -076.6744939\n1.6   G4000        A 25151223822 6979843236 +38.9466584 -076.6744939\n1.7   G4000        A 25151223822 6979843236 +38.9466584 -076.6744939\n1.8   G4000        A 25151223822 6979843236 +38.9466584 -076.6744939\n1.9   G4000        A 25151223822 6979843236 +38.9466584 -076.6744939\n         LINEARID      FULLNAME RTTYP MTFCC.y                       geometry\n1   1104258795090 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.756 39....\n1.1 1103075320064 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.756 39....\n1.2 1104258795072 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.756 39....\n1.3 1104258845568 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.756 39....\n1.4  110191599447 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.756 39....\n1.5  110191599448 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.756 39....\n1.6 1102149806067 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.756 39....\n1.7 1102149813008 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.756 39....\n1.8 1102149806121 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.756 39....\n1.9 1102166635559 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.756 39....\n```\n\n\n:::\n:::\n\n\n### Non-overlapping joins\n\n`st_is_within_distance()` is an example of a non-overlapping join:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_is_within_distance(us_highways, maryland, dist = units::set_units(100, \"mi\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSparse geometry binary predicate list of length 17522, where the\npredicate was `is_within_distance'\nfirst 10 elements:\n 1: (empty)\n 2: (empty)\n 3: (empty)\n 4: (empty)\n 5: (empty)\n 6: (empty)\n 7: (empty)\n 8: (empty)\n 9: (empty)\n 10: (empty)\n```\n\n\n:::\n:::\n\n\n### Filtering with spatial joins\n\nYou can use these joins for spatial filters using the base R syntax:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nis_hwy_within_dist <- st_is_within_distance(\n  us_highways,\n  maryland,\n  dist = units::set_units(100, \"mi\"),\n  sparse = FALSE\n)\nus_highways[is_hwy_within_dist, ]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 2258 features and 4 fields\nGeometry type: LINESTRING\nDimension:     XY\nBounding box:  xmin: -81.72573 ymin: 36.57507 xmax: -74.04969 ymax: 41.34626\nGeodetic CRS:  NAD83\nFirst 10 features:\n          LINEARID      FULLNAME RTTYP MTFCC                       geometry\n17  11013853809147 State Rte 611     S S1100 LINESTRING (-75.1366 40.350...\n18  11013853809270 State Rte 611     S S1100 LINESTRING (-75.12634 40.28...\n19  11013853809430 State Rte 611     S S1100 LINESTRING (-75.12603 40.28...\n75  11013853864377  State Rte 29     S S1100 LINESTRING (-74.76432 40.20...\n226  1105598256809  State Rte 26     S S1100 LINESTRING (-77.73622 40.89...\n228  1108296536943  State Rte 26     S S1100 LINESTRING (-74.76814 40.20...\n229  1108296536969  State Rte 26     S S1100 LINESTRING (-74.71174 40.27...\n231  1104486135566  State Rte 26     S S1100 LINESTRING (-77.73356 40.89...\n246  1108296538090 State Rte 129     S S1100 LINESTRING (-74.72239 40.18...\n247  1108296538091 State Rte 129     S S1100 LINESTRING (-74.7224 40.183...\n```\n\n\n:::\n:::\n\n\n### Filtering with spatial joins\n\nOr using `filter()` if you use the name of the geomtery column (and convert the matrix output into a logical vector):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfilter(\n  us_highways,\n  as.logical(st_is_within_distance(\n    geometry,\n    maryland,\n    dist = units::set_units(100, \"mi\"),\n    sparse = FALSE\n  ))\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 2258 features and 4 fields\nGeometry type: LINESTRING\nDimension:     XY\nBounding box:  xmin: -81.72573 ymin: 36.57507 xmax: -74.04969 ymax: 41.34626\nGeodetic CRS:  NAD83\nFirst 10 features:\n         LINEARID      FULLNAME RTTYP MTFCC                       geometry\n1  11013853809147 State Rte 611     S S1100 LINESTRING (-75.1366 40.350...\n2  11013853809270 State Rte 611     S S1100 LINESTRING (-75.12634 40.28...\n3  11013853809430 State Rte 611     S S1100 LINESTRING (-75.12603 40.28...\n4  11013853864377  State Rte 29     S S1100 LINESTRING (-74.76432 40.20...\n5   1105598256809  State Rte 26     S S1100 LINESTRING (-77.73622 40.89...\n6   1108296536943  State Rte 26     S S1100 LINESTRING (-74.76814 40.20...\n7   1108296536969  State Rte 26     S S1100 LINESTRING (-74.71174 40.27...\n8   1104486135566  State Rte 26     S S1100 LINESTRING (-77.73356 40.89...\n9   1108296538090 State Rte 129     S S1100 LINESTRING (-74.72239 40.18...\n10  1108296538091 State Rte 129     S S1100 LINESTRING (-74.7224 40.183...\n```\n\n\n:::\n:::\n\n\n### Spatial aggregation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nus_states_combine <- us_states |>\n  group_by(DIVISION) |>\n  summarise(\n    geometry = st_combine(geometry)\n  )\n\nplot(us_states_combine[, 1])\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-14-1.png){width=960}\n:::\n:::\n\n\n## Types of geometric operations\n\n-   Simplification\n-   Centroids\n-   Buffers\n-   Clipping (with or without subsetting)\n-   Unions\n-   Type transformations\n\n### Simplification\n\n\n::: {.cell execure='false'}\n\n```{.r .cell-code}\nst_simplify(lower48, dTolerance = 100000)[, 1]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 49 features and 1 field (with 5 geometries empty)\nGeometry type: GEOMETRY\nDimension:     XY\nBounding box:  xmin: -124.7989 ymin: 25.40562 xmax: -66.90256 ymax: 49.00013\nGeodetic CRS:  NAD83\nFirst 10 features:\n   REGION                       geometry\n1       3 POLYGON ((-78.36567 39.3604...\n2       3 POLYGON ((-81.34136 25.4056...\n3       2 POLYGON ((-89.45747 37.1908...\n4       2 POLYGON ((-89.96571 47.2914...\n5       3 POLYGON ((-75.78628 39.6205...\n6       1       GEOMETRYCOLLECTION EMPTY\n7       4 POLYGON ((-115.9605 47.8981...\n8       1 POLYGON ((-70.9832 43.39448...\n9       3 POLYGON ((-75.71132 36.2501...\n10      1 POLYGON ((-71.58543 44.5129...\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-16-1.png){width=960}\n:::\n:::\n\n\n### Centroids\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(st_centroid(lower48)[, 1])\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-17-1.png){width=960}\n:::\n:::\n\n\n### Buffers\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(st_buffer(lower48, dist = 100)[, 1])\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-18-1.png){width=960}\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(st_buffer(lower48, dist = units::set_units(100, \"mi\"))[, 1])\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-19-1.png){width=960}\n:::\n:::\n\n\n### Clipping (with or without subsetting)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(st_intersection(us_highways, maryland)[, 1])\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-20-1.png){width=960}\n:::\n:::\n\n\n### Unions\n\n\n::: {.cell}\n\n```{.r .cell-code}\nus_highways_union <- us_highways |>\n  group_by(RTTYP) |>\n  summarise(\n    geometry = st_union(geometry)\n  )\n\nplot(us_highways_union[, 1])\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-21-1.png){width=960}\n:::\n:::\n\n\n### Type transformations\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(st_cast(us_highways[1, ], to = \"POINT\"))\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-22-1.png){width=960}\n:::\n:::\n\n",
    "supporting": [
      "feature-geometry_files/figure-revealjs"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}