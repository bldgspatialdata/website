{
  "hash": "2cdcefd8cbc543a4fa26a8fe095ab81b",
  "result": {
    "engine": "knitr",
    "markdown": "---\norder: 5\ntitle: \"Working with spatial and geometric operations in `{sf}`\"\nsubtitle: \"Session {{< meta order >}}\"\ndate-meta: 2023-09-27\nformat: \n  revealjs:\n    output-location: column-fragment\n---\n\n\n## Getting started\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(tigris)\noptions(tigris_use_cache = TRUE)\n```\n:::\n\n\n----\n\n\n::: {.cell}\n\n```{.r .cell-code}\noptions(\"tigris_use_cache\" = TRUE)\nus_states <- states()\nus_highways <- primary_roads()\nmaryland <- filter(us_states, NAME == \"Maryland\")\nlower48 <- filter(us_states, !(NAME %in% c(\"United States Virgin Islands\", \"Commonwealth of the Northern Mariana Islands\", \"Guam\", \"Alaska\", \"American Samoa\", \"Puerto Rico\", \"Hawaii\")))\n```\n:::\n\n\n## Converting objects between types\n\n----\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsfg <- st_point(c(-76.712838, 39.253383))\n\nsfg\n```\n:::\n\n\n----\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_as_sfc(list(sfg))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGeometry set for 1 feature \nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -76.71284 ymin: 39.25338 xmax: -76.71284 ymax: 39.25338\nCRS:           NA\n```\n\n\n:::\n:::\n\n\n----\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsfc <- st_as_sfc(list(sfg), crs = 4326)\n\nsfc\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGeometry set for 1 feature \nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -76.71284 ymin: 39.25338 xmax: -76.71284 ymax: 39.25338\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n:::\n\n\n----\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_as_sf(sfc)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 1 feature and 0 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -76.71284 ymin: 39.25338 xmax: -76.71284 ymax: 39.25338\nGeodetic CRS:  WGS 84\n                           x\n1 POINT (-76.71284 39.25338)\n```\n\n\n:::\n:::\n\n\n----\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsf_df <- data.frame(\n  name = \"Example data frame\",\n  lon = -76.712838,\n  lat = 39.253383\n)\n\nsf <- st_as_sf(sf_df, coords = c(\"lon\", \"lat\"), crs = 4326)\n\nsf\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 1 feature and 1 field\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -76.71284 ymin: 39.25338 xmax: -76.71284 ymax: 39.25338\nGeodetic CRS:  WGS 84\n                name                   geometry\n1 Example data frame POINT (-76.71284 39.25338)\n```\n\n\n:::\n:::\n\n\n## Types of spatial operations\n\n- Spatial filtering and topological relations\n- Spatial joins and non-overlapping joins\n- Spatial aggregation\n\n### Spatial filtering and topological relations\n\n`st_filter()` efaults to intersecting geometries:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_filter(us_states, maryland)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 14 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -83.67539 ymin: 36.54085 xmax: -74.68956 ymax: 42.51607\nGeodetic CRS:  NAD83\n  REGION DIVISION STATEFP  STATENS GEOID STUSPS                 NAME LSAD MTFCC\n1      3        5      54 01779805    54     WV        West Virginia   00 G4000\n2      3        5      24 01714934    24     MD             Maryland   00 G4000\n3      3        5      10 01779781    10     DE             Delaware   00 G4000\n4      1        2      42 01779798    42     PA         Pennsylvania   00 G4000\n5      3        5      51 01779803    51     VA             Virginia   00 G4000\n6      3        5      11 01702382    11     DC District of Columbia   00 G4000\n  FUNCSTAT        ALAND     AWATER    INTPTLAT     INTPTLON\n1        A  62266298634  489204185 +38.6472854 -080.6183274\n2        A  25151992308 6979074857 +38.9466584 -076.6744939\n3        A   5046731559 1399179670 +38.9985661 -075.4416440\n4        A 115881784866 3397909903 +40.9046013 -077.8275298\n5        A 102258210137 8528040726 +37.5222512 -078.6681938\n6        A    158316124   18709762 +38.9042474 -077.0165167\n                        geometry\n1 MULTIPOLYGON (((-80.85847 3...\n2 MULTIPOLYGON (((-75.76659 3...\n3 MULTIPOLYGON (((-75.13846 3...\n4 MULTIPOLYGON (((-75.5931 39...\n5 MULTIPOLYGON (((-77.76715 3...\n6 MULTIPOLYGON (((-77.11975 3...\n```\n\n\n:::\n:::\n\n\n-----\n\n`st_filter()` can also support alternate topological relations:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_filter(us_states, maryland, .predicate = st_disjoint)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 50 features and 14 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -179.2311 ymin: -14.60181 xmax: 179.8597 ymax: 71.43979\nGeodetic CRS:  NAD83\nFirst 10 features:\n   REGION DIVISION STATEFP  STATENS GEOID STUSPS           NAME LSAD MTFCC\n1       3        5      12 00294478    12     FL        Florida   00 G4000\n2       2        3      17 01779784    17     IL       Illinois   00 G4000\n3       2        4      27 00662849    27     MN      Minnesota   00 G4000\n4       1        1      44 01219835    44     RI   Rhode Island   00 G4000\n5       4        8      16 01779783    16     ID          Idaho   00 G4000\n6       1        1      33 01779794    33     NH  New Hampshire   00 G4000\n7       3        5      37 01027616    37     NC North Carolina   00 G4000\n8       1        1      50 01779802    50     VT        Vermont   00 G4000\n9       1        1      09 01779780    09     CT    Connecticut   00 G4000\n10      4        8      35 00897535    35     NM     New Mexico   00 G4000\n   FUNCSTAT        ALAND      AWATER    INTPTLAT     INTPTLON\n1         A 138961722096 45972570361 +28.3989775 -082.5143005\n2         A 143778561906  6216493488 +40.1028754 -089.1526108\n3         A 206232627084 18949394733 +46.3159573 -094.1996043\n4         A   2677763359  1323686988 +41.5964850 -071.5264901\n5         A 214049931578  2391569647 +44.3484222 -114.5588538\n6         A  23190115212  1025971768 +43.6726907 -071.5843145\n7         A 125933327733 13456093195 +35.5397100 -079.1308636\n8         A  23872569964  1030754609 +44.0589536 -072.6710173\n9         A  12541690473  1816424193 +41.5798637 -072.7466572\n10        A 314198560947   726482113 +34.4346843 -106.1316181\n                         geometry\n1  MULTIPOLYGON (((-83.10874 2...\n2  MULTIPOLYGON (((-89.17208 3...\n3  MULTIPOLYGON (((-92.74568 4...\n4  MULTIPOLYGON (((-71.67881 4...\n5  MULTIPOLYGON (((-111.0455 4...\n6  MULTIPOLYGON (((-71.24548 4...\n7  MULTIPOLYGON (((-76.91598 3...\n8  MULTIPOLYGON (((-72.43462 4...\n9  MULTIPOLYGON (((-72.5279 41...\n10 MULTIPOLYGON (((-104.8477 3...\n```\n\n\n:::\n:::\n\n\n-----\n\n![](https://r.geocompx.org/04-spatial-operations_files/figure-html/relations-1.png)\n\n### Spatial joins and non-overlapping joins\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_join(maryland, us_highways)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 471 features and 18 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -79.48765 ymin: 37.88661 xmax: -74.98628 ymax: 39.72304\nGeodetic CRS:  NAD83\nFirst 10 features:\n    REGION DIVISION STATEFP  STATENS GEOID STUSPS     NAME LSAD MTFCC.x\n1        3        5      24 01714934    24     MD Maryland   00   G4000\n1.1      3        5      24 01714934    24     MD Maryland   00   G4000\n1.2      3        5      24 01714934    24     MD Maryland   00   G4000\n1.3      3        5      24 01714934    24     MD Maryland   00   G4000\n1.4      3        5      24 01714934    24     MD Maryland   00   G4000\n1.5      3        5      24 01714934    24     MD Maryland   00   G4000\n1.6      3        5      24 01714934    24     MD Maryland   00   G4000\n1.7      3        5      24 01714934    24     MD Maryland   00   G4000\n1.8      3        5      24 01714934    24     MD Maryland   00   G4000\n1.9      3        5      24 01714934    24     MD Maryland   00   G4000\n    FUNCSTAT       ALAND     AWATER    INTPTLAT     INTPTLON      LINEARID\n1          A 25151992308 6979074857 +38.9466584 -076.6744939 1104258795072\n1.1        A 25151992308 6979074857 +38.9466584 -076.6744939 1104258845568\n1.2        A 25151992308 6979074857 +38.9466584 -076.6744939  110191599447\n1.3        A 25151992308 6979074857 +38.9466584 -076.6744939  110191599448\n1.4        A 25151992308 6979074857 +38.9466584 -076.6744939 1102149806121\n1.5        A 25151992308 6979074857 +38.9466584 -076.6744939 1102149806067\n1.6        A 25151992308 6979074857 +38.9466584 -076.6744939 1102149813008\n1.7        A 25151992308 6979074857 +38.9466584 -076.6744939 1102166635559\n1.8        A 25151992308 6979074857 +38.9466584 -076.6744939 1104258795090\n1.9        A 25151992308 6979074857 +38.9466584 -076.6744939 1103075320064\n         FULLNAME RTTYP MTFCC.y                       geometry\n1   Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.76659 3...\n1.1 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.76659 3...\n1.2 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.76659 3...\n1.3 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.76659 3...\n1.4 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.76659 3...\n1.5 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.76659 3...\n1.6 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.76659 3...\n1.7 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.76659 3...\n1.8 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.76659 3...\n1.9 Salisbury Byp     M   S1100 MULTIPOLYGON (((-75.76659 3...\n```\n\n\n:::\n:::\n\n\n----\n\n`st_is_within_distance()` is an example of a non-overlapping join:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_is_within_distance(us_highways, maryland, dist = units::set_units(100, \"mi\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSparse geometry binary predicate list of length 17378, where the\npredicate was `is_within_distance'\nfirst 10 elements:\n 1: (empty)\n 2: (empty)\n 3: (empty)\n 4: (empty)\n 5: (empty)\n 6: (empty)\n 7: (empty)\n 8: (empty)\n 9: (empty)\n 10: (empty)\n```\n\n\n:::\n:::\n\n\n----\n\nYou can use these joins for spatial filters using the base R syntax:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nis_hwy_within_dist <- st_is_within_distance(us_highways, maryland, dist = units::set_units(100, \"mi\"), sparse = FALSE)\nus_highways[is_hwy_within_dist, ]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 2245 features and 4 fields\nGeometry type: LINESTRING\nDimension:     XY\nBounding box:  xmin: -81.72573 ymin: 36.57507 xmax: -74.04969 ymax: 41.34626\nGeodetic CRS:  NAD83\nFirst 10 features:\n          LINEARID      FULLNAME RTTYP MTFCC                       geometry\n17  11013853809147 State Rte 611     S S1100 LINESTRING (-75.1366 40.350...\n18  11013853809270 State Rte 611     S S1100 LINESTRING (-75.12634 40.28...\n19  11013853809430 State Rte 611     S S1100 LINESTRING (-75.12603 40.28...\n77  11013853864377  State Rte 29     S S1100 LINESTRING (-74.76432 40.20...\n219  1108296536943  State Rte 26     S S1100 LINESTRING (-74.76814 40.20...\n220  1108296536969  State Rte 26     S S1100 LINESTRING (-74.71174 40.27...\n221  1104486135566  State Rte 26     S S1100 LINESTRING (-77.73356 40.89...\n223  1105598256809  State Rte 26     S S1100 LINESTRING (-77.73622 40.89...\n239  1108296538090 State Rte 129     S S1100 LINESTRING (-74.72239 40.18...\n240  1108296538091 State Rte 129     S S1100 LINESTRING (-74.7224 40.183...\n```\n\n\n:::\n:::\n\n\n----\n\nOr using `filter()` if you use the name of the geomtery column (and convert the matrix output into a logical vector):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfilter(us_highways, as.logical(st_is_within_distance(geometry, maryland, dist = units::set_units(100, \"mi\"), sparse = FALSE)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 2245 features and 4 fields\nGeometry type: LINESTRING\nDimension:     XY\nBounding box:  xmin: -81.72573 ymin: 36.57507 xmax: -74.04969 ymax: 41.34626\nGeodetic CRS:  NAD83\nFirst 10 features:\n         LINEARID      FULLNAME RTTYP MTFCC                       geometry\n1  11013853809147 State Rte 611     S S1100 LINESTRING (-75.1366 40.350...\n2  11013853809270 State Rte 611     S S1100 LINESTRING (-75.12634 40.28...\n3  11013853809430 State Rte 611     S S1100 LINESTRING (-75.12603 40.28...\n4  11013853864377  State Rte 29     S S1100 LINESTRING (-74.76432 40.20...\n5   1108296536943  State Rte 26     S S1100 LINESTRING (-74.76814 40.20...\n6   1108296536969  State Rte 26     S S1100 LINESTRING (-74.71174 40.27...\n7   1104486135566  State Rte 26     S S1100 LINESTRING (-77.73356 40.89...\n8   1105598256809  State Rte 26     S S1100 LINESTRING (-77.73622 40.89...\n9   1108296538090 State Rte 129     S S1100 LINESTRING (-74.72239 40.18...\n10  1108296538091 State Rte 129     S S1100 LINESTRING (-74.7224 40.183...\n```\n\n\n:::\n:::\n\n\n### Spatial aggregation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nus_states_combine <- us_states |>\n  group_by(DIVISION) |>\n  summarise(\n    geometry = st_combine(geometry)\n  )\n\nplot(us_states_combine[, 1])\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-14-1.png){width=960}\n:::\n:::\n\n\n## Types of geometric operations\n\n- Simplification\n- Centroids\n- Buffers\n- Clipping (with or without subsetting)\n- Unions\n- Type transformations\n\n### Simplification\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(st_simplify(lower48, dTolerance = 100000)[, 1])\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-15-1.png){width=960}\n:::\n:::\n\n\n### Centroids\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(st_centroid(lower48)[, 1])\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-16-1.png){width=960}\n:::\n:::\n\n\n### Buffers\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(st_buffer(lower48, dist = 100)[, 1])\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-17-1.png){width=960}\n:::\n:::\n\n\n-----\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(st_buffer(lower48, dist = units::set_units(100, \"mi\"))[, 1])\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-18-1.png){width=960}\n:::\n:::\n\n\n### Clipping (with or without subsetting)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(st_intersection(us_highways, maryland)[, 1])\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-19-1.png){width=960}\n:::\n:::\n\n\n### Unions\n\n\n::: {.cell}\n\n```{.r .cell-code}\nus_highways_union <- us_highways |>\n  group_by(RTTYP) |>\n  summarise(\n    geometry = st_union(geometry)\n  )\n\nplot(us_highways_union[, 1])\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-20-1.png){width=960}\n:::\n:::\n\n\n### Type transformations\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(st_cast(us_highways[1, ], to = \"POINT\"))\n```\n\n::: {.cell-output-display}\n![](feature-geometry_files/figure-revealjs/unnamed-chunk-21-1.png){width=960}\n:::\n:::\n",
    "supporting": [
      "feature-geometry_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}